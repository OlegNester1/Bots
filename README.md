# ТГ‑боты для обучения

Репозиторий с тремя учебными Telegram‑ботами:

1. **Маркетплейс** — каталог учебных материалов/курсов с заказами и оплатой (песочница).
2. **Ассист‑бот для чатов** — помощник в группах (модерация, ответы на FAQ, заметки).
3. **Поиск напарника** — матчинг по интересам/навыкам + личные чаты.

> Цель — показать архитектурные паттерны, работу с БД, модерацию, очереди задач и хорошую практику организации репозитория.

---

## Стек

* **Python 3.11+**
* **pyTelegramBotAPI (telebot)** или **aiogram 3** (на выбор по проекту)
* **PostgreSQL 15** + SQLAlchemy 2/asyncpg
* **Redis** (кэш, rate‑limit, очереди задач)
* **Celery / RQ** (фоновые задачи)
* **Docker & Docker Compose**
* **Poetry** для управления зависимостями
* Линтеры: **ruff**, форматер **black**, типы **mypy**
* Тесты: **pytest**

---

## Быстрый старт

### 1) Клонирование

```bash
git clone https://github.com/<your-org>/<repo-name>.git
cd <repo-name>
```

### 2) Переменные окружения

Создайте файлы `.env` в корне и/или в папках ботов. Пример:

```env
# Общие
ENV=dev
LOG_LEVEL=INFO
DATABASE_URL=postgresql+psycopg://postgres:postgres@db:5432/tgbots
REDIS_URL=redis://redis:6379/0

# Телеграм
TELEGRAM_BOT_TOKEN=<token>
TELEGRAM_ADMINS=123456789,987654321

# Платежи (для маркетплейса)
PAYMENTS_PROVIDER=fake
PAYMENTS_API_KEY=<key>

# Матчинг (поиск напарника)
MATCH_DISTANCE_KM=50
```

### 3) Docker (рекомендуется)

```bash
docker compose up --build
```

Сервисы поднимутся: `app_*` (боты), `db` (PostgreSQL), `redis`, воркеры фоновых задач.

### 4) Без Docker (локально)

```bash
poetry install
poetry run alembic upgrade head
poetry run python apps/marketplace/bot.py
poetry run python apps/assistant/bot.py
poetry run python apps/matcher/bot.py
```

---

## Бот 1 — Маркетплейс

**Возможности**

* Каталог курсов/материалов: категории, поиск, фильтры
* Корзина, оформление заказа, «песочница» оплаты
* Промокоды, статусы заказов, квитанции в PDF
* Админ‑команды: добавление товара, выгрузка CSV

**Команды**

* `/start` — приветствие, меню
* `/catalog` — каталог
* `/cart` — корзина
* `/orders` — мои заказы
* `/admin` — админ‑панель (для `TELEGRAM_ADMINS`)

**Сервисы**

* `services/catalog.py` — CRUD каталога
* `services/payments.py` — адаптер платежей (Fake/Stripe/ЮKassa)

---

## Бот 2 — Ассист‑бот для чатов

**Возможности**

* Автомодерация: антиспам, удаление ссылок/матов, муты
* Ответы на FAQ по ключевым словам
* Заметки/пины от модераторов, напоминания в чате
* Выгрузка статистики активности

**Команды (в чате)**

* `/help` — справка
* `/note <текст>` — закрепить заметку (админы)
* `/faq add <триггер> = <ответ>` — пополнить базу FAQ (админы)
* `/stats` — статистика за период

**Миддлвары/фильтры**

* `middlewares/antispam.py`
* `middlewares/moderation.py`

---

## Бот 3 — Поиск напарника

**Возможности**

* Создание анкеты (навыки, цели, город/часовой пояс)
* Матчинг по критериям (+ расстояние, если включено)
* Взаимные лайки → личный диалог/линк
* Модерация анкет через второго бота/панель

**Команды**

* `/start` — анкета/меню
* `/profile` — моя анкета
* `/search` — поиск совпадений
* `/likes` — входящие/исходящие

**Алгоритм**

* Скорая эвристика: TF‑IDF по навыкам + фильтры (город, цели, язык)
* Опционально: ML‑ререйнг (BM25/annoy/faiss) — выключено по умолчанию

---

## Настройка и конфигурация

* Конфиг через `pydantic` в `common/config.py`
* Логи: `common/logging.py` (JSON‑логи, ротация)
* Миграции БД: `alembic` (`poetry run alembic upgrade head`)
* i18n: заготовка для многоязычия `locales/`

---

## Скрипты Makefile

```Makefile
setup:        # poetry install + pre-commit
lint:         # ruff + mypy
fmt:          # black --check
fmt-fix:      # black
test:         # pytest -q
up:           # docker compose up -d
logs:         # docker compose logs -f --tail=100
```

---

## Тестирование

```bash
poetry run pytest -q
```

* Юнит‑тесты на сервисы/хендлеры
* Фикстуры Telegram‑апи замоканы
* Интеграционные тесты с тестовой БД (pytest‑postgresql)

---

## CI/CD (пример)

* GitHub Actions: линт, тесты, сборка образов
* Автотег релизов, push в GHCR, деплой на сервер через SSH/Ansible

Пример workflow: `.github/workflows/ci.yml` (заготовка в репозитории)

---

## Безопасность и приватность

* Храните токены только в `.env`/секретах CI
* Rate‑limit и антиспам включены по умолчанию в ассист‑боте
* В маркетплейсе платежи — только в режиме песочницы до валидации

---

## Дорожная карта

* [ ] Веб‑панель админа (FastAPI + admin)
* [ ] Инлайн‑режим для ассист‑бота
* [ ] Экспорт/импорт каталога (CSV/Excel)
* [ ] ML‑ререйнг матчинга

---

## Как внести вклад

1. Форкните репозиторий
2. Создайте ветку `feature/<имя>`
3. Сделайте PR с описанием
4. Пройдите все проверки CI

Шаблон PR и issue — в `.github/`.

---

## Лицензия

MIT (см. `LICENSE`).

---

## Контакты

* Вопросы/баги — в Issues
* Предложения — в Discussions

> Замените заглушки (`<repo-name>`, токены, провайдеры платежей) перед запуском.
